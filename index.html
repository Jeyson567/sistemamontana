<!DOCTYPE html>
<html lang="es">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Sistemas de Inventario Completos</title>
	<style>
		body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f4f4f4; }
		.container { max-width: 900px; margin: 30px auto; background: #fff; padding: 30px; border-radius: 10px; box-shadow: 0 2px 8px #0002; }
		h2 { color: #2c3e50; }
		.section { margin-bottom: 40px; }
		input, select, button { margin: 5px 0; padding: 7px; border-radius: 4px; border: 1px solid #ccc; }
		table { width: 100%; border-collapse: collapse; margin-top: 10px; }
		th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
		th { background: #2980b9; color: #fff; }
		.admin-section { background: #eaf6ff; padding: 15px; border-radius: 8px; }
		.hidden { display: none; }
		.success { color: green; }
		.error { color: red; }
	</style>
</head>
<body>
<div class="container">
	<h1>Sistemas de Inventario Completos</h1>
	<div id="menu-principal">
		<h2>Selecciona el inventario</h2>
		<button onclick="mostrarInventario('A')">Inventario Bar</button>
		<button onclick="mostrarInventario('B')">Inventario Cocina</button>
	</div>
	<div class="section" id="inventarioA" style="display:none">
		<button onclick="volverMenu()">&larr; Volver al menú</button>
		<h2>Inventario Bar</h2>
		<div>
			<h3>Registrar Producto</h3>
			<input type="text" id="a-nombre" placeholder="Nombre del producto">
			<input type="number" id="a-cantidad" placeholder="Cantidad inicial">
			<button onclick="agregarProducto('A')">Agregar</button>
			<span id="a-add-msg"></span>
		</div>
		<div>
			<h3>Inventario Actual</h3>
			<button onclick="exportarInventarioCSV('A')">Exportar Inventario a CSV</button>
			<table id="a-tabla-inventario">
				<thead>
					<tr><th>Producto</th><th>Categoría</th><th>Cantidad</th><th>Acciones</th></tr>
				</thead>
				<tbody></tbody>
			</table>
		</div>
		<div>
			<h3>Resumen de Ventas del Día</h3>
			<button onclick="exportarVentasDiaCSV('A')">Exportar Ventas Día a CSV</button>
			<table id="a-tabla-ventas-dia">
				<thead>
					<tr><th>Producto</th><th>Cantidad Vendida</th><th>Acciones</th></tr>
				</thead>
				<tbody></tbody>
			</table>
			<div id="a-total-dia"></div>
		</div>
		<div>
			<h3>Historial de Movimientos</h3>
			<button onclick="exportarHistorialCSV('A')">Exportar Historial a CSV</button>
			<table id="a-tabla-historial">
				<thead>
					<tr><th>Fecha</th><th>Tipo</th><th>Producto</th><th>Categoría</th><th>Cantidad</th><th>Usuario</th></tr>
				</thead>
				<tbody></tbody>
			</table>
		</div>
		<div class="admin-section">
			<h3>Corte Semanal (Admin)</h3>
			<input type="password" id="a-admin-pass" placeholder="Contraseña admin">
			<button onclick="mostrarCorte('A')">Ver Corte</button>
			<div id="a-corte-semanal" class="hidden"></div>
		</div>
		<div>
			<h3>Conteo y Corroboración de Inventario</h3>
			<button onclick="corroborarInventario('A')">Corroborar Inventario</button>
			<div id="a-corroboracion"></div>
		</div>
	</div>
	<hr>
	<!-- Aquí irá el Inventario B -->
	<div class="section" id="inventarioB" style="display:none">
		<button onclick="volverMenu()">&larr; Volver al menú</button>
		<h2>Inventario Cocina</h2>
		<div>
			<h3>Registrar Producto</h3>
			<input type="text" id="b-nombre" placeholder="Nombre del producto">
			<input type="number" id="b-cantidad" placeholder="Cantidad inicial">
			<button onclick="agregarProducto('B')">Agregar</button>
			<span id="b-add-msg"></span>
		</div>
		<div>
			<h3>Inventario Actual</h3>
			<button onclick="exportarInventarioCSV('B')">Exportar Inventario a CSV</button>
			<table id="b-tabla-inventario">
				<thead>
					<tr><th>Producto</th><th>Categoría</th><th>Cantidad</th><th>Acciones</th></tr>
				</thead>
				<tbody></tbody>
			</table>
		</div>
		<div>
			<h3>Resumen de Ventas del Día</h3>
			<button onclick="exportarVentasDiaCSV('B')">Exportar Ventas Día a CSV</button>
			<table id="b-tabla-ventas-dia">
				<thead>
					<tr><th>Producto</th><th>Cantidad Vendida</th><th>Acciones</th></tr>
				</thead>
				<tbody></tbody>
			</table>
			<div id="b-total-dia"></div>
		</div>
		<div>
			<h3>Historial de Movimientos</h3>
			<button onclick="exportarHistorialCSV('B')">Exportar Historial a CSV</button>
			<table id="b-tabla-historial">
				<thead>
					<tr><th>Fecha</th><th>Tipo</th><th>Producto</th><th>Categoría</th><th>Cantidad</th><th>Usuario</th></tr>
				</thead>
				<tbody></tbody>
			</table>
		</div>
		<div class="admin-section">
			<h3>Corte Semanal (Admin)</h3>
			<input type="password" id="b-admin-pass" placeholder="Contraseña admin">
			<button onclick="mostrarCorte('B')">Ver Corte</button>
			<div id="b-corte-semanal" class="hidden"></div>
		</div>
		<div>
			<h3>Conteo y Corroboración de Inventario</h3>
			<button onclick="corroborarInventario('B')">Corroborar Inventario</button>
			<div id="b-corroboracion"></div>
		</div>
	</div>
</div>
<script>
// Configuración de contraseñas admin (puedes cambiar estas)
const adminPasswords = { A: 'adminA123', B: 'adminB123' };

// Utilidades de LocalStorage y CSV
function getData(key) {
	return JSON.parse(localStorage.getItem(key) || '[]');
}
function setData(key, data) {
	localStorage.setItem(key, JSON.stringify(data));
}
function getToday() {
	const d = new Date();
	// Obtener fecha local en formato YYYY-MM-DD
	const year = d.getFullYear();
	const month = String(d.getMonth() + 1).padStart(2, '0');
	const day = String(d.getDate()).padStart(2, '0');
	return `${year}-${month}-${day}`;
}
function getNow() {
	const d = new Date();
	// Obtener fecha y hora local en formato YYYY-MM-DD HH:MM:SS
	const year = d.getFullYear();
	const month = String(d.getMonth() + 1).padStart(2, '0');
	const day = String(d.getDate()).padStart(2, '0');
	const hours = String(d.getHours()).padStart(2, '0');
	const minutes = String(d.getMinutes()).padStart(2, '0');
	const seconds = String(d.getSeconds()).padStart(2, '0');
	return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
}
function getWeek() {
	const d = new Date();
	const year = d.getFullYear();
	const onejan = new Date(d.getFullYear(),0,1);
	const week = Math.ceil((((d - onejan) / 86400000) + onejan.getDay()+1)/7);
	return `${year}-W${week}`;
}
function toCSV(rows) {
	return rows.map(r => r.map(x => {
		let s = String(x).replace(/"/g, '""');
		if (s.search(/[",\n]/) >= 0) s = '"' + s + '"';
		return s;
	}).join(',')).join('\r\n');
}
function downloadCSV(filename, rows) {
	const csv = toCSV(rows);
	const blob = new Blob([csv], {type: 'text/csv'});
	const url = URL.createObjectURL(blob);
	const a = document.createElement('a');
	a.href = url; a.download = filename; a.click();
	setTimeout(()=>URL.revokeObjectURL(url), 1000);
}

// Inventario y ventas por sistema
function getKeys(sistema) {
	return {
		inventario: `inv_${sistema}`,
		ventas: `ventas_${sistema}`,
		corte: `corte_${sistema}`,
		historial: `historial_${sistema}`
	};
}

function agregarProducto(sistema) {
	const nombre = document.getElementById(`${sistema.toLowerCase()}-nombre`).value.trim();
	const cantidad = parseInt(document.getElementById(`${sistema.toLowerCase()}-cantidad`).value);
	let categoria = prompt('Categoría del producto (ej: Bebidas, Alimentos, etc):', '');
	if (!categoria) categoria = 'Sin categoría';
	const msg = document.getElementById(`${sistema.toLowerCase()}-add-msg`);
	if (!nombre || isNaN(cantidad) || cantidad <= 0) {
		msg.textContent = 'Datos inválidos'; msg.className = 'error'; return;
	}
	let inventario = getData(getKeys(sistema).inventario);
	let idx = inventario.findIndex(p => p.nombre.toLowerCase() === nombre.toLowerCase());
	if (idx >= 0) {
		if (!confirm('El producto ya existe. ¿Deseas actualizarlo y sumar la cantidad?')) return;
		inventario[idx].cantidad += cantidad;
		inventario[idx].categoria = categoria;
		registrarHistorial(sistema, 'Actualización', nombre, categoria, cantidad);
	} else {
		inventario.push({ nombre, cantidad, categoria });
		registrarHistorial(sistema, 'Alta', nombre, categoria, cantidad);
	}
	setData(getKeys(sistema).inventario, inventario);
	msg.textContent = 'Producto agregado/actualizado'; msg.className = 'success';
	document.getElementById(`${sistema.toLowerCase()}-nombre`).value = '';
	document.getElementById(`${sistema.toLowerCase()}-cantidad`).value = '';
	renderInventario(sistema);
	renderHistorial(sistema);
}

function venderProducto(sistema, nombre) {
	const cantidad = parseInt(prompt('Cantidad a vender de ' + nombre + ':'));
	if (isNaN(cantidad) || cantidad <= 0) return;
	let inventario = getData(getKeys(sistema).inventario);
	let idx = inventario.findIndex(p => p.nombre === nombre);
	if (idx < 0 || inventario[idx].cantidad < cantidad) {
		alert('No hay suficiente inventario'); return;
	}
	inventario[idx].cantidad -= cantidad;
	setData(getKeys(sistema).inventario, inventario);
	// Registrar venta
	let ventas = getData(getKeys(sistema).ventas);
	const today = getToday();
	ventas.push({ nombre, cantidad, fecha: today, categoria: inventario[idx].categoria });
	setData(getKeys(sistema).ventas, ventas);
	registrarHistorial(sistema, 'Venta', nombre, inventario[idx].categoria, cantidad);
	renderInventario(sistema);
	renderVentasDia(sistema);
	renderHistorial(sistema);
}

function renderInventario(sistema) {
	const inventario = getData(getKeys(sistema).inventario);
	const tbody = document.querySelector(`#${sistema.toLowerCase()}-tabla-inventario tbody`);
	tbody.innerHTML = '';
	inventario.forEach((p, i) => {
		tbody.innerHTML += `<tr><td>${p.nombre}</td><td>${p.categoria||''}</td><td>${p.cantidad}</td><td><button onclick=\"venderProducto('${sistema}','${p.nombre}')\">Vender</button> <button onclick=\"editarProducto('${sistema}',${i})\">Editar</button> <button onclick=\"eliminarProducto('${sistema}',${i})\">Eliminar</button></td></tr>`;
	});
}

function renderVentasDia(sistema) {
	const ventas = getData(getKeys(sistema).ventas).filter(v => v.fecha === getToday());
	const resumen = {};
	ventas.forEach((v, idx) => {
		if (!resumen[v.nombre]) resumen[v.nombre] = { cantidad: 0, idxs: [] };
		resumen[v.nombre].cantidad += v.cantidad;
		resumen[v.nombre].idxs.push(idx);
	});
	const tbody = document.querySelector(`#${sistema.toLowerCase()}-tabla-ventas-dia tbody`);
	tbody.innerHTML = '';
	let totalDia = 0;
	Object.keys(resumen).forEach(nombre => {
		tbody.innerHTML += `<tr><td>${nombre}</td><td>${resumen[nombre].cantidad}</td><td><button onclick=\"editarVenta('${sistema}','${nombre}')\">Editar</button> <button onclick=\"eliminarVenta('${sistema}','${nombre}')\">Eliminar</button></td></tr>`;
		totalDia += resumen[nombre].cantidad;
	});
	document.getElementById(`${sistema.toLowerCase()}-total-dia`).textContent = 'Total del día: ' + totalDia;
}
// Historial de movimientos
function registrarHistorial(sistema, tipo, nombre, categoria, cantidad, usuario) {
	let historial = getData(getKeys(sistema).historial);
	historial.push({ fecha: getNow(), tipo, nombre, categoria, cantidad, usuario: usuario||'admin' });
	setData(getKeys(sistema).historial, historial);
}

function renderHistorial(sistema) {
	const historial = getData(getKeys(sistema).historial);
	const tbody = document.querySelector(`#${sistema.toLowerCase()}-tabla-historial tbody`);
	tbody.innerHTML = '';
	historial.slice(-100).reverse().forEach(h => {
		tbody.innerHTML += `<tr><td>${h.fecha}</td><td>${h.tipo}</td><td>${h.nombre}</td><td>${h.categoria||''}</td><td>${h.cantidad}</td><td>${h.usuario||''}</td></tr>`;
	});
}

// Exportar a CSV
function exportarInventarioCSV(sistema) {
	var inventario = getData(getKeys(sistema).inventario);
	var rows = [['Producto','Categoría','Cantidad']].concat(inventario.map(p=>[p.nombre,p.categoria||'',p.cantidad]));
	downloadCSV(`inventario_${sistema}.csv`, rows);
}
function exportarVentasDiaCSV(sistema) {
	var ventas = getData(getKeys(sistema).ventas).filter(v=>v.fecha===getToday());
	var rows = [['Producto','Categoría','Cantidad','Fecha']].concat(ventas.map(v=>[v.nombre,v.categoria||'',v.cantidad,v.fecha]));
	downloadCSV(`ventas_dia_${sistema}.csv`, rows);
}
function exportarHistorialCSV(sistema) {
	var historial = getData(getKeys(sistema).historial);
	var rows = [['Fecha','Tipo','Producto','Categoría','Cantidad','Usuario']].concat(historial.map(h=>[h.fecha,h.tipo,h.nombre,h.categoria||'',h.cantidad,h.usuario||'']));
	downloadCSV(`historial_${sistema}.csv`, rows);
}

// Editar y eliminar productos solo con contraseña admin
function editarProducto(sistema, idx) {
	const pass = prompt('Contraseña admin para editar:');
	if (pass !== adminPasswords[sistema]) {
		alert('Contraseña incorrecta'); return;
	}
	let inventario = getData(getKeys(sistema).inventario);
	let p = inventario[idx];
	let nombre = prompt('Nuevo nombre:', p.nombre) || p.nombre;
	let categoria = prompt('Nueva categoría:', p.categoria) || p.categoria;
	let cantidad = parseInt(prompt('Nueva cantidad:', p.cantidad));
	if (!nombre || isNaN(cantidad) || cantidad < 0) return alert('Datos inválidos');
	registrarHistorial(sistema, 'Edición', nombre, categoria, cantidad);
	inventario[idx] = { nombre, categoria, cantidad };
	setData(getKeys(sistema).inventario, inventario);
	renderInventario(sistema);
	renderHistorial(sistema);
}
function eliminarProducto(sistema, idx) {
	const pass = prompt('Contraseña admin para eliminar:');
	if (pass !== adminPasswords[sistema]) {
		alert('Contraseña incorrecta'); return;
	}
	if (!confirm('¿Seguro que deseas eliminar este producto?')) return;
	let inventario = getData(getKeys(sistema).inventario);
	registrarHistorial(sistema, 'Eliminación', inventario[idx].nombre, inventario[idx].categoria, inventario[idx].cantidad);
	inventario.splice(idx,1);
	setData(getKeys(sistema).inventario, inventario);
	renderInventario(sistema);
	renderHistorial(sistema);
}
function editarVenta(sistema, nombre) {
	let ventas = getData(getKeys(sistema).ventas);
	let idx = ventas.findIndex(v => v.nombre === nombre && v.fecha === getToday());
	if (idx < 0) return;
	let cantidad = parseInt(prompt('Nueva cantidad vendida:', ventas[idx].cantidad));
	if (isNaN(cantidad) || cantidad < 0) return alert('Datos inválidos');
	registrarHistorial(sistema, 'Edición Venta', nombre, ventas[idx].categoria, cantidad);
	ventas[idx].cantidad = cantidad;
	setData(getKeys(sistema).ventas, ventas);
	renderVentasDia(sistema);
	renderHistorial(sistema);
}
function eliminarVenta(sistema, nombre) {
	if (!confirm('¿Seguro que deseas eliminar esta venta?')) return;
	let ventas = getData(getKeys(sistema).ventas);
	let idx = ventas.findIndex(v => v.nombre === nombre && v.fecha === getToday());
	if (idx < 0) return;
	registrarHistorial(sistema, 'Eliminación Venta', nombre, ventas[idx].categoria, ventas[idx].cantidad);
	ventas.splice(idx,1);
	setData(getKeys(sistema).ventas, ventas);
	renderVentasDia(sistema);
	renderHistorial(sistema);
}
// Menú para elegir inventario
function mostrarInventario(sistema) {
	document.getElementById('menu-principal').style.display = 'none';
	document.getElementById('inventarioA').style.display = sistema === 'A' ? '' : 'none';
	document.getElementById('inventarioB').style.display = sistema === 'B' ? '' : 'none';
}
function volverMenu() {
	document.getElementById('menu-principal').style.display = '';
	document.getElementById('inventarioA').style.display = 'none';
	document.getElementById('inventarioB').style.display = 'none';
}

function mostrarCorte(sistema) {
	const pass = document.getElementById(`${sistema.toLowerCase()}-admin-pass`).value;
	if (pass !== adminPasswords[sistema]) {
		alert('Contraseña incorrecta'); return;
	}
	// Ventas de la semana agrupadas por día
	const ventas = getData(getKeys(sistema).ventas).filter(v => getWeekFromDate(v.fecha) === getWeek());
	const ventasPorDia = {};
	ventas.forEach(v => {
		if (!ventasPorDia[v.fecha]) ventasPorDia[v.fecha] = [];
		ventasPorDia[v.fecha].push(v);
	});
	let html = `<h4>Ventas de la semana actual (día por día)</h4>`;
	Object.keys(ventasPorDia).sort().forEach(dia => {
		html += `<b>${dia}</b><table><thead><tr><th>Producto</th><th>Cantidad</th></tr></thead><tbody>`;
		ventasPorDia[dia].forEach(v => {
			html += `<tr><td>${v.nombre}</td><td>${v.cantidad}</td></tr>`;
		});
		html += `</tbody></table>`;
	});
	// Historial de ediciones y eliminaciones
	const historial = getData(getKeys(sistema).historial).filter(h => {
		return getWeekFromDate(h.fecha && h.fecha.substr(0,10)) === getWeek() && (h.tipo === 'Edición' || h.tipo === 'Eliminación' || h.tipo === 'Actualización');
	});
	if (historial.length > 0) {
		html += `<h4>Ediciones y cambios manuales de la semana</h4><table><thead><tr><th>Fecha</th><th>Tipo</th><th>Producto</th><th>Categoría</th><th>Cantidad</th><th>Usuario</th></tr></thead><tbody>`;
		historial.forEach(h => {
			html += `<tr><td>${h.fecha}</td><td>${h.tipo}</td><td>${h.nombre}</td><td>${h.categoria||''}</td><td>${h.cantidad}</td><td>${h.usuario||''}</td></tr>`;
		});
		html += `</tbody></table>`;
	}
	document.getElementById(`${sistema.toLowerCase()}-corte-semanal`).innerHTML = html;
	document.getElementById(`${sistema.toLowerCase()}-corte-semanal`).classList.remove('hidden');
}

function getWeekFromDate(dateStr) {
	const d = new Date(dateStr);
	const year = d.getFullYear();
	const onejan = new Date(d.getFullYear(),0,1);
	const week = Math.ceil((((d - onejan) / 86400000) + onejan.getDay()+1)/7);
	return `${year}-W${week}`;
}

function corroborarInventario(sistema) {
	const inventario = getData(getKeys(sistema).inventario);
	let html = '<h4>Conteo actual de inventario</h4><table><thead><tr><th>Producto</th><th>Cantidad</th></tr></thead><tbody>';
	inventario.forEach(p => {
		html += `<tr><td>${p.nombre}</td><td>${p.cantidad}</td></tr>`;
	});
	html += '</tbody></table>';
	document.getElementById(`${sistema.toLowerCase()}-corroboracion`).innerHTML = html;
}

// Inicializar tablas al cargar
window.onload = function() {
	renderInventario('A');
	renderVentasDia('A');
	renderHistorial('A');
	renderInventario('B');
	renderVentasDia('B');
	renderHistorial('B');
	document.getElementById('menu-principal').style.display = '';
	document.getElementById('inventarioA').style.display = 'none';
	document.getElementById('inventarioB').style.display = 'none';
}
</script>
</body>
</html>
